#cloud-config

users:
  - default
  - name: support
    gecos: Support User
    shell: /bin/bash
    groups: [wheel]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    lock_passwd: false
    ssh_authorized_keys: []

chpasswd:
  expire: false
  list: |
    support:strongPassword123

write_files:
  - path: /etc/ssh/sshd_config.d/99-password-auth.conf
    permissions: '0644'
    content: |
      PasswordAuthentication yes

runcmd:
  - |
    if [ -f /home/ec2-user/.ssh/authorized_keys ]; then
      mkdir -p /home/support/.ssh
      cp /home/ec2-user/.ssh/authorized_keys /home/support/.ssh/
      chown -R support:support /home/support/.ssh
      chmod 700 /home/support/.ssh
      chmod 600 /home/support/.ssh/authorized_keys
    fi
  - systemctl restart sshd
